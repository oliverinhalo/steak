<!DOCTYPE html>
<head>
    <title>Jacobs Steak Tracking</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="static/styles.css">
</head>
<body>
        <div class="page-shell">
        <header class="site-header fade-in">
            <div class="brand">
                <div class="logo" aria-hidden="true"></div>
                <div>
                    <div class="site-title">Jacob's Steak Tracker</div>
                    <div class="site-sub">Quick mobile steak logging</div>
                </div>
            </div>
            <div class="controls">
                                <div id="login-area">
                                    <span id="who" class="muted">Not signed in</span>
                                    <button class="btn secondary" id="btn-show-login">Sign In</button>
                                </div>
                                <button class="btn" id="new-log">New</button>
            </div>
        </header>

        <main class="container">
        <div class="parent">
        <div class="new">
            <header>New Steak</header>
            <form id="Steak-form" enctype="multipart/form-data">
            <div>
                <label for="Steak-cost">Steak Cost in Â£:</label>
                <input type="number" id="Steak-cost" name="Steak-cost" step="any">

                <br>

                <label for="Steak-weight">Steak weight in Grams:</label>
                <input type="number" id="Steak-weight" name="Steak-weight" step="any">

                <br>

                <label for="Steak-type">Steak Type:</label>
                <select class="i" id="Steak-type" name="Steak-type"></select>

                <br>

                <div id="camera-area">
                    <video id="video" autoplay playsinline style="max-width:320px; display:none;"></video>
                    <img id="preview-img" class="preview-img" style="display:none;max-width:320px;border-radius:8px;margin-top:8px;" alt="Captured photo">
                    <canvas id="canvas" style="display:none;"></canvas>
                    <div>
                        <button type="button" id="open-camera">Open Camera</button>
                        <button type="button" id="capture" style="display:none;">Capture Photo</button>
                        <button type="button" id="flip-camera" style="display:none;">Flip Camera</button>
                        <button type="button" id="close-camera" style="display:none;">Close Camera</button>
                    </div>
                    <div id="upload-status" style="margin-top:8px;font-size:0.9rem;color:green"></div>
                </div>

                <br>

                <button type="submit" id="add-Steak-btn">Add Steak</button>
            </div>
            </form>
        </div>
        <div class="log">
            <header>Your Steak Logs</header>
            <div id="log-entries"></div>
        </div>
    </div>
        <script type="module" src="static/app.module.js"></script>
        <script src="app.js" defer></script>
        <script src="camera.js" defer></script>

        <!-- Login / Register modal -->
        <div id="login-modal" style="display:none;position:fixed;left:8px;right:8px;top:18%;padding:14px;border-radius:12px;background:var(--card);z-index:1200;backdrop-filter:blur(6px);box-shadow:0 12px 30px rgba(0,0,0,0.5)">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <div style="font-weight:700">Sign In / Register</div>
                <button id="login-cancel" class="btn secondary">Close</button>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px">
                <label class="muted">Choose username</label>
                <select id="user-list" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.05)"></select>
                <label class="muted">Display name (optional)</label>
                <input id="register-name" type="text" placeholder="Your name" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.05)">
                <label class="muted">Email (optional)</label>
                <input id="register-email" type="email" placeholder="you@example.com" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.05)">
                <label class="muted">Password</label>
                <input id="login-pass" type="password" placeholder="password" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.05)">
                <div style="display:flex;gap:8px;justify-content:flex-end">
                    <button id="btn-register" class="btn secondary">Register</button>
                    <button id="btn-login" class="btn">Login</button>
                </div>
            </div>
        </div>

        <script>
            (function(){
                const who = document.getElementById('who');
                const btnShow = document.getElementById('btn-show-login');
                const modal = document.getElementById('login-modal');
                const userList = document.getElementById('user-list');
                const passInput = document.getElementById('login-pass');
                const btnLogin = document.getElementById('btn-login');
                const btnRegister = document.getElementById('btn-register');
                const btnCancel = document.getElementById('login-cancel');

                function setUser(id){ localStorage.setItem('user_id', id); who.textContent = 'Signed as ' + id; }
                const existing = localStorage.getItem('user_id');
                if(existing) who.textContent = 'Signed as ' + existing;

                async function refreshUsers(){
                    try{
                        const res = await fetch('/users');
                        if(!res.ok) throw new Error('Failed');
                        const list = await res.json();
                        userList.innerHTML = '';
                        if(list.length===0){ const opt = document.createElement('option'); opt.value=''; opt.textContent='(no users)'; userList.appendChild(opt); }
                        list.forEach(u=>{ const o=document.createElement('option'); o.value=u.username; o.textContent = u.username + (u.name ? (' \u2014 ' + u.name) : ''); userList.appendChild(o); });
                    }catch(e){ userList.innerHTML=''; const o=document.createElement('option'); o.textContent='(error)'; userList.appendChild(o);} 
                }

                btnShow.addEventListener('click', async ()=>{ await refreshUsers(); passInput.value=''; modal.style.display='block'; passInput.focus(); });
                btnCancel.addEventListener('click', ()=>{ modal.style.display='none'; });

                btnLogin.addEventListener('click', async ()=>{
                    const username = userList.value || prompt('Enter username');
                    const password = passInput.value;
                    if(!username || !password){ alert('Provide username and password'); return; }
                    try{
                        const r = await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})});
                        if(!r.ok) { const j=await r.json().catch(()=>({})); throw new Error(j.error||r.statusText||'Login failed'); }
                        const j = await r.json(); setUser(j.user); modal.style.display='none'; location.reload();
                    }catch(e){ alert('Login failed: '+(e.message||e)); }
                });

                btnRegister.addEventListener('click', async ()=>{
                    const username = userList.value || prompt('Choose a username');
                    const password = passInput.value || prompt('Choose a password');
                    const name = document.getElementById('register-name').value || '';
                    const email = document.getElementById('register-email').value || '';
                    if(!username || !password){ alert('Provide username and password'); return; }
                    try{
                        const r = await fetch('/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password,name,email})});
                        if(!r.ok){ const j=await r.json().catch(()=>({})); throw new Error(j.error||r.statusText||'Register failed'); }
                        const j = await r.json(); setUser(j.user); modal.style.display='none'; location.reload();
                    }catch(e){ alert('Register failed: '+(e.message||e)); }
                });
            })();
        </script>
</body>

<style>
    .parent {
        display: grid;
        grid-template-columns: repeat(2,1fr);
        grid-template-rows: repeat(1,1fr);
        grid-column-gap: 0px;
        grid-row-gap: 0px;
    }

    .i {font-style: italic;}
</style>